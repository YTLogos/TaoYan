<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>比对 | Tao Yan</title>
    <link>https://taoyan.netlify.app/tags/%E6%AF%94%E5%AF%B9/</link>
      <atom:link href="https://taoyan.netlify.app/tags/%E6%AF%94%E5%AF%B9/index.xml" rel="self" type="application/rss+xml" />
    <description>比对</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>© Tao Yan, 2018-2020</copyright><lastBuildDate>Tue, 03 Sep 2019 16:19:05 +0000</lastBuildDate>
    <image>
      <url>https://taoyan.netlify.app/img/pom-card.png</url>
      <title>比对</title>
      <link>https://taoyan.netlify.app/tags/%E6%AF%94%E5%AF%B9/</link>
    </image>
    
    <item>
      <title>转录组数据分析01-比对</title>
      <link>https://taoyan.netlify.app/post/2019-09-03.%E8%BD%AC%E5%BD%95%E7%BB%84%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%9001/</link>
      <pubDate>Tue, 03 Sep 2019 16:19:05 +0000</pubDate>
      <guid>https://taoyan.netlify.app/post/2019-09-03.%E8%BD%AC%E5%BD%95%E7%BB%84%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%9001/</guid>
      <description>&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/YTLogos/pic_link/master/img/20190904101824.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;最近有一批转录组数据需要分析，从公司拿到&lt;code&gt;raw data&lt;/code&gt;之后进行后续分析。目前转录组测序十分成熟，测序质量都很高，所以我这里就简单地质控一下，由
&lt;a href=&#34;https://github.com/OpenGene/fastp&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;fastp&lt;/strong&gt;&lt;/a&gt;完成。&lt;/p&gt;
&lt;h2 id=&#34;质控&#34;&gt;质控&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#安装fastp
# get source (you can also use browser to download from master or releases)
git clone https://github.com/OpenGene/fastp.git

# build
cd fastp
make

# Install
sudo make install

#没有root权限的话可以使用conda安装或者下载二进制文件
# note: the fastp version in bioconda may be not the latest
conda install -c bioconda fastp

# this binary was compiled on CentOS, and tested on CentOS/Ubuntu
wget http://opengene.org/fastp/fastp
chmod a+x ./fastp
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;之后批量进行质控，一条龙服务，十分方便了。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash
for i in {01..45}
do
~/biosoft/fastp/bin/fastp -i /database/Bna-rna-seq-analyis/data/Cole_M838-01-T${i}_good_1.fq.gz -o /database/Bna-rna-seq-analyis/data/T${i}_good_1.fq.gz -I /database/Bna-rna-seq-analyis/data/Cole_M838-01-T${i}_good_2.fq.gz -O /database/Bna-rna-seq-analyis/data/T${i}_good_2.fq.gz
done
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;比对&#34;&gt;比对&lt;/h2&gt;
&lt;p&gt;比对软件有很多，主流的主要有
&lt;a href=&#34;http://ccb.jhu.edu/software/hisat2/index.shtml&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HISAT2&lt;/a&gt;以及
&lt;a href=&#34;https://github.com/alexdobin/STAR&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;STAR&lt;/a&gt;。&lt;/p&gt;
&lt;h3 id=&#34;star比对&#34;&gt;STAR比对&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;#Download the latest release from and uncompress it
# Get latest STAR source from releases
wget https://github.com/alexdobin/STAR/archive/2.7.2b.tar.gz
tar -xzf 2.7.2b.tar.gz
cd STAR-2.7.2b

# Alternatively, get STAR source using git
git clone https://github.com/alexdobin/STAR.git

#Compile under Linux
# Compile
cd STAR/source
make STAR
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;STAR&lt;/code&gt;使用格式如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;STAR --option1-name option1-value --option2-name option2-value ...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;STAR&lt;/code&gt;的文档写的非常详细，这也是一个好软件的标志之一，如果一个软件的文档都写的不详细的话，可以考虑换一个软件。&lt;code&gt;STAR&lt;/code&gt;参数非常多，尤其现在还支持三代测序数据。有兴趣的话可以自己去研究
&lt;a href=&#34;https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;文档&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&#34;star构建索引&#34;&gt;STAR构建索引&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash

set -e
set -u
set -o pipefail


fasta=/database/reference/Bna_NY7/NY7-chr/NY_V2_Chr.fasta
gtf=/database/reference/Bna_NY7/NY7-chr/NY7_V2_Chr.gtf
STAR=/home/taoyan/biosoft/STAR/bin/Linux_x86_64_static/STAR

# Generate index Of Brassica napus

$STAR --runMode genomeGenerate \
--runThreadN 32 \
--genomeFastaFiles $fasta \
--genomeDir /database/reference/Bna_NY7/NY7-chr/NY7.Star.Index \
--sjdbGTFfile $gtf \
--genomeSAindexNbases 13 \
--sjdbOverhang 149
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;构建索引常用命令参数如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;ndash;runMode genomeGenerate：运行模式为构建索引&lt;/li&gt;
&lt;li&gt;&amp;ndash;runThreadN：设置线程数&lt;/li&gt;
&lt;li&gt;&amp;ndash;genomeDir：构建的索引文件存放路径，需要提前创建该文件夹&lt;/li&gt;
&lt;li&gt;&amp;ndash;genomeFastaFiles：参考基因组文件&lt;/li&gt;
&lt;li&gt;&amp;ndash;sjdbGTFfile：注释文件gtf，推荐在这一步添加，虽然可以在后续比对的时候添加&lt;/li&gt;
&lt;li&gt;&amp;ndash;genomeSAindexNbases 对于非常小的参考基因组，此参数需要按比例缩小，其计算方式为min(14, log2(GenomeLength)/2 - 1)，所以一般为14，但是小基因组比如1M的话，此值应为9，这里按照我的参考基因组大小，应该为14，但是我运行的时候提示我最优值为13，暂时不清楚为何提示我这个值。此值一般在10~15之间，越大需要越多的内存，相应的话速度也越快。&lt;/li&gt;
&lt;li&gt;&amp;ndash;sjdbOverhang：读段长度-1，默认为99，我的序列是PE150，所以此值应为149，文档显示99可以达到最理想的效果，所以不知道具体的建库方式的话，此参数设为99就行了。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;批量比对&#34;&gt;批量比对&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash

set -e
set -u
set -o pipefail


fasta=/database/reference/Bna_NY7/NY7-chr/NY_V2_Chr.fasta
gtf=/database/reference/Bna_NY7/NY7-chr/NY7_V2_Chr.gtf
STAR=/home/taoyan/biosoft/STAR/bin/Linux_x86_64_static/STAR

seq_data=/database/Bna.rnaseq.NY7.analysis/data/seq.data
result=/database/Bna.rnaseq.NY7.analysis/result/Star/Star_map_bam

# sequence mapping use STAR

for i in {01..45}
do
echo &amp;quot; ******* Process Sample T${i} ******* &amp;quot;
$STAR --runThreadN 64 \        #线程数
--genomeDir /database/reference/Bna_NY7/NY7-chr/NY7.Star.Index/ \  #索引目录
--readFilesCommand zcat \   #执行解压缩，输入数据格式为gz文件
--readFilesIn $seq_data/T${i}_good_1.fq.gz \  #输入文件
$seq_data/T${i}_good_2.fq.gz \
--outSAMtype BAM SortedByCoordinate \  #指定输出bam文件并排序
--outFileNamePrefix $result/Bna_Star_T${i}. \  #输出文件路径以及前缀
--outBAMsortingThreadN 20 \   #排序线程数
--quantMode TranscriptomeSAM GeneCounts #将上面基因组比对的信息转化为转录本比对的信息，quantMode TranscriptomeSAM will output alignments translated into trancript coordinates,为了后续使用RSEM定量准备输入文件
done
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;一些常用参数解释：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;ndash;runThreadN：线程数&lt;/li&gt;
&lt;li&gt;&amp;ndash;runMode alignReads : 默认就是比对模式，所以这里我没填写&lt;/li&gt;
&lt;li&gt;&amp;ndash;genomeDir：索引文件所在文件夹，就是上面建立索引时的文件夹&lt;/li&gt;
&lt;li&gt;&amp;ndash;readFilesCommand zcat：由于现在大部分序列数据都是压缩形式的，所以需要解压缩，我的数据是gz格式的，所以这里是zcat&lt;/li&gt;
&lt;li&gt;&amp;ndash;readFilesIn：序列数据&lt;/li&gt;
&lt;li&gt;&amp;ndash;outSAMtype BAM SortedByCoordinate：输出文件为bam文件，并且进行了排序，这里应该是按照pos排序的。&lt;/li&gt;
&lt;li&gt;&amp;ndash;outBAMsortingThreadN：SAM文件排序生成BAM文件时的线程数，不要设置太大，不然会报错的。&lt;/li&gt;
&lt;li&gt;&amp;ndash;quantMode TranscriptomeSAM GeneCounts：这个参数需要特别注意，如果你后续要使用RSEM进行定量，就需要添加TranscriptomeSAM，不然生成的BAM文件RSEM无法使用的，GeneCounts生成用于后续featureCounts分析的输入文件&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;STAR还有其它很多参数，讲不完的，基本来说一般的转录组分析上面这些参数够用了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;由于后续定量我们会用到RSEM，所以这里特别注意需要加参数&lt;code&gt;--quantMode TranscriptomeSAM GeneCounts&lt;/code&gt;，这样生成的bam文件可用于后续的RSEM定量以及featureCounts计数。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;这里比对的时候我遇到了我问题:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;&amp;quot;FATAL ERROR: could not create output file ... Solution: check that you have permission to write this file&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;Google搜索之后发现是系统限制了最大文件打开的数目，默认是1024，我改为了10000，后续比对正常运行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;#先查看你的系统打开文件限制数目
$ ulimit -n
1024
#设置一个更大的数目
$ ulimit -n 10000
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;hisat2比对&#34;&gt;HISAT2比对&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;#下载源文件
wget http://ccb.jhu.edu/software/hisat2/downloads/hisat2-2.0.0-beta-source.zip
unzip hisat2-2.0.0-beta-source.zip
cd hisat2-2.0.0-beta-source
make
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;HISAT2&lt;/code&gt;用法如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;hisat2 [options]* -x &amp;lt;hisat2-idx&amp;gt; {-1 &amp;lt;m1&amp;gt; -2 &amp;lt;m2&amp;gt; | -U &amp;lt;r&amp;gt; | --sra-acc &amp;lt;SRA accession number&amp;gt;} [-S &amp;lt;hit&amp;gt;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;更详细用法见
&lt;a href=&#34;http://ccb.jhu.edu/software/hisat2/manual.shtml&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;文档&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&#34;hisat2建立索引&#34;&gt;HISAT2建立索引&lt;/h4&gt;
&lt;p&gt;我这里遇到一个问题，建立索引之后比对的时候报错：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;(ERR): hisat2-align died with signal 11 (SEGV) (core dumped)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Google发现是建立的索引出问题了，HISAT2建立索引的时候会根据基因组大小来建立小索引还是大索引，一般4G以下的基因组都会默认建立小基因组，32位的，以&lt;code&gt;.ht2&lt;/code&gt;为后缀的，我这里报错了，所以我特意设置参数建立了64位的以&lt;code&gt;.ht21&lt;/code&gt;为后缀的大索引，后续比对就没问题了&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash

set -e
set -u
set -o pipefail


##构建exons以及splice_sites文件，由于我的注释文件是GFF3文件,所以需要转化成GTF

~/biosoft/gffread/gffread NY7_V2_Chr.gff3 -T -o NY7_V2_Chr.gtf
~/biosoft/hisat2-2.0.0-beta/extract_exons.py NY7_V2_Chr.gtf &amp;gt; NY7_V2_Chr.exons
~/biosoft/hisat2-2.0.0-beta/extract_splice_sites.py NY7_V2_Chr.gtf &amp;gt; NY7_V2_Chr.ss

##构建索引,这里需要提供exons，splite_sites文件，参考基因组文件以及输出文件前缀
##Hisat2-build可以构建任意大小的参考基因组索引，小于4G的参考基因组，构建出来的索引以.ht2为后缀的文件，更大的参考基因组是以.ht21为后缀的文件

~/biosoft/hisat2-2.0.0-beta/hisat2-build -p 64 --large-index --ss NY7_V2_Chr.ss --exon NY7_V2_Chr.exon NY_V2_Chr.fasta NY7.Hisat2.Index/NY7_V2_Chr_Hisat2_index 2 &amp;gt; Hisat_build_index.log
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;批量比对-1&#34;&gt;批量比对&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash

set -e
set -u
set -o pipefail

hisat2=/home/taoyan/biosoft/hisat2-2.0.0-beta/hisat2
index=/database/reference/Bna_NY7/NY7-chr/NY7.Hisat2.Index
seq_data=/database/Bna.rnaseq.NY7.analysis/data/seq.data
result=/database/Bna.rnaseq.NY7.analysis/result/Hisat2
samtools=/home/taoyan/biosoft/samtools1.9/bin/samtools

for i in {01..45}
do
$hisat2 -t -p 64 --dta -x $index/NY7_V2_Chr_Hisat2_index -1 $seq_data/T${i}_good_1.fq.gz -2 $seq_data/T${i}_good_2.fq.gz | $samtools sort -@ 8 -O bam -o $result/T${i}.sorted.bam
done
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;具体参数就不详讲了，具体见
&lt;a href=&#34;http://ccb.jhu.edu/software/hisat2/manual.shtml&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;文档&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;后续主要进行定量了，下次讲。&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>
